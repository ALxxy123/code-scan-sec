"""
Tests for vulnerability scanner.
"""

import pytest
from pathlib import Path
import tempfile
from vulnerability_scanner import (
    VulnerabilityScanner,
    Vulnerability,
    scan_for_vulnerabilities
)


class TestVulnerabilityScanner:
    """Test suite for vulnerability scanner."""

    @pytest.fixture
    def sample_vulnerable_code(self, tmp_path):
        """Create sample vulnerable code file."""
        test_file = tmp_path / "vulnerable.py"
        code = """
import os

# SQL Injection vulnerability
def get_user(user_id):
    query = "SELECT * FROM users WHERE id = " + user_id
    return execute(query)

# Command Injection vulnerability
def run_command(cmd):
    os.system(cmd)

# XSS vulnerability (for web framework)
def render_page(user_input):
    return "<div>" + user_input + "</div>"

# Weak crypto
import hashlib
password_hash = hashlib.md5(password.encode()).hexdigest()

# Eval usage
def calculate(expression):
    return eval(expression)
"""
        test_file.write_text(code)
        return str(test_file)

    def test_scanner_initialization(self):
        """Test scanner initialization."""
        scanner = VulnerabilityScanner()
        assert scanner is not None
        assert hasattr(scanner, 'rules')

    def test_scan_sql_injection(self, sample_vulnerable_code):
        """Test SQL injection detection."""
        scanner = VulnerabilityScanner()
        vulns = scanner.scan_file(sample_vulnerable_code)

        sql_vulns = [v for v in vulns if 'sql' in v.category.lower()]
        assert len(sql_vulns) > 0

        sql_vuln = sql_vulns[0]
        assert sql_vuln.severity in ['critical', 'high']
        assert 'SQL' in sql_vuln.name or 'sql' in sql_vuln.name.lower()

    def test_scan_command_injection(self, sample_vulnerable_code):
        """Test command injection detection."""
        scanner = VulnerabilityScanner()
        vulns = scanner.scan_file(sample_vulnerable_code)

        cmd_vulns = [v for v in vulns if 'command' in v.category.lower()]
        assert len(cmd_vulns) > 0

    def test_scan_weak_crypto(self, sample_vulnerable_code):
        """Test weak cryptography detection."""
        scanner = VulnerabilityScanner()
        vulns = scanner.scan_file(sample_vulnerable_code)

        crypto_vulns = [v for v in vulns if 'crypto' in v.category.lower()]
        assert len(crypto_vulns) > 0

    def test_scan_dangerous_functions(self, sample_vulnerable_code):
        """Test dangerous function detection."""
        scanner = VulnerabilityScanner()
        vulns = scanner.scan_file(sample_vulnerable_code)

        dangerous_vulns = [v for v in vulns if 'dangerous' in v.category.lower()]
        assert len(dangerous_vulns) > 0

    def test_vulnerability_severity_score(self):
        """Test vulnerability severity scoring."""
        critical_vuln = Vulnerability(
            name="Test Critical",
            severity="critical",
            cwe="CWE-89",
            owasp="A03:2021",
            pattern="test",
            description="Test",
            recommendation="Test",
            file_path="/test.py",
            line_number=1,
            matched_text="test",
            category="test",
            languages=["python"]
        )

        assert critical_vuln.severity_score == 5

        low_vuln = Vulnerability(
            name="Test Low",
            severity="low",
            cwe="CWE-200",
            owasp="A05:2021",
            pattern="test",
            description="Test",
            recommendation="Test",
            file_path="/test.py",
            line_number=1,
            matched_text="test",
            category="test",
            languages=["python"]
        )

        assert low_vuln.severity_score == 2

    def test_vulnerability_to_dict(self):
        """Test vulnerability conversion to dictionary."""
        vuln = Vulnerability(
            name="Test Vuln",
            severity="high",
            cwe="CWE-78",
            owasp="A03:2021",
            pattern="exec\\(",
            description="Dangerous exec usage",
            recommendation="Avoid exec",
            file_path="/test.py",
            line_number=10,
            matched_text="exec(cmd)",
            category="command_injection",
            languages=["python"]
        )

        vuln_dict = vuln.to_dict()

        assert vuln_dict['name'] == "Test Vuln"
        assert vuln_dict['severity'] == "high"
        assert vuln_dict['cwe'] == "CWE-78"
        assert vuln_dict['line_number'] == 10

    def test_get_statistics(self):
        """Test vulnerability statistics generation."""
        scanner = VulnerabilityScanner()

        vulns = [
            Vulnerability(
                name="Vuln 1",
                severity="critical",
                cwe="CWE-89",
                owasp="A03:2021",
                pattern="test",
                description="Test",
                recommendation="Test",
                file_path="/test.py",
                line_number=1,
                matched_text="test",
                category="sql_injection",
                languages=["python"]
            ),
            Vulnerability(
                name="Vuln 2",
                severity="high",
                cwe="CWE-78",
                owasp="A03:2021",
                pattern="test",
                description="Test",
                recommendation="Test",
                file_path="/test.py",
                line_number=2,
                matched_text="test",
                category="command_injection",
                languages=["python"]
            ),
            Vulnerability(
                name="Vuln 3",
                severity="medium",
                cwe="CWE-79",
                owasp="A03:2021",
                pattern="test",
                description="Test",
                recommendation="Test",
                file_path="/test.py",
                line_number=3,
                matched_text="test",
                category="xss",
                languages=["python"]
            ),
        ]

        stats = scanner.get_statistics(vulns)

        assert stats['total'] == 3
        assert stats['critical_and_high'] == 2
        assert stats['by_severity']['critical'] == 1
        assert stats['by_severity']['high'] == 1
        assert stats['by_severity']['medium'] == 1

    def test_filter_by_severity(self):
        """Test filtering vulnerabilities by severity."""
        scanner = VulnerabilityScanner()

        vulns = [
            Vulnerability(
                name=f"Vuln {i}",
                severity=sev,
                cwe="CWE-1",
                owasp="A03:2021",
                pattern="test",
                description="Test",
                recommendation="Test",
                file_path="/test.py",
                line_number=i,
                matched_text="test",
                category="test",
                languages=["python"]
            )
            for i, sev in enumerate(['critical', 'high', 'medium', 'low', 'info'], 1)
        ]

        # Filter for high and above
        filtered = scanner.filter_by_severity(vulns, 'high')
        assert len(filtered) == 2  # critical and high

        # Filter for medium and above
        filtered = scanner.filter_by_severity(vulns, 'medium')
        assert len(filtered) == 3  # critical, high, medium

    def test_sort_by_severity(self):
        """Test sorting vulnerabilities by severity."""
        scanner = VulnerabilityScanner()

        vulns = [
            Vulnerability(
                name=f"Vuln {i}",
                severity=sev,
                cwe="CWE-1",
                owasp="A03:2021",
                pattern="test",
                description="Test",
                recommendation="Test",
                file_path="/test.py",
                line_number=i,
                matched_text="test",
                category="test",
                languages=["python"]
            )
            for i, sev in enumerate(['low', 'info', 'critical', 'medium', 'high'], 1)
        ]

        sorted_vulns = scanner.sort_by_severity(vulns)

        assert sorted_vulns[0].severity == 'critical'
        assert sorted_vulns[1].severity == 'high'
        assert sorted_vulns[-1].severity == 'info'
