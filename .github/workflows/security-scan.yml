name: Security Scan

on:
  push:
    branches: [ main, master, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_path:
        description: 'Path to scan'
        required: false
        default: '.'
      ai_provider:
        description: 'AI Provider (gemini/openai/claude)'
        required: false
        default: 'gemini'
      enable_ai:
        description: 'Enable AI verification'
        required: false
        default: 'true'

jobs:
  security-scan:
    name: Run Security Scanner
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Security Scanner
        run: |
          python -m pip install --upgrade pip
          pip install security-scan-cli

      - name: Run Security Scan
        id: scan
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          SCAN_PATH="${{ github.event.inputs.scan_path || '.' }}"
          AI_PROVIDER="${{ github.event.inputs.ai_provider || 'gemini' }}"
          ENABLE_AI="${{ github.event.inputs.enable_ai || 'true' }}"

          # Determine AI flags
          if [ "$ENABLE_AI" = "true" ]; then
            AI_FLAGS="--ai-provider $AI_PROVIDER"
          else
            AI_FLAGS="--no-ai"
          fi

          # Run scan and capture exit code
          set +e
          security-scan scan \
            --path "$SCAN_PATH" \
            $AI_FLAGS \
            --output all \
            --quiet

          SCAN_EXIT_CODE=$?
          set -e

          echo "exit_code=$SCAN_EXIT_CODE" >> $GITHUB_OUTPUT

          # Check if findings exist
          if [ -f "output/report.json" ]; then
            TOTAL_SECRETS=$(jq '.summary.total_secrets // 0' output/report.json)
            TOTAL_VULNS=$(jq '.summary.total_vulnerabilities // 0' output/report.json)
            CRITICAL_VULNS=$(jq '.summary.vulnerability_stats.by_severity.critical // 0' output/report.json)
            HIGH_VULNS=$(jq '.summary.vulnerability_stats.by_severity.high // 0' output/report.json)

            echo "total_secrets=$TOTAL_SECRETS" >> $GITHUB_OUTPUT
            echo "total_vulnerabilities=$TOTAL_VULNS" >> $GITHUB_OUTPUT
            echo "critical_vulnerabilities=$CRITICAL_VULNS" >> $GITHUB_OUTPUT
            echo "high_vulnerabilities=$HIGH_VULNS" >> $GITHUB_OUTPUT
          fi

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-reports
          path: output/
          retention-days: 30

      - name: Upload JSON Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-json
          path: output/report.json
          retention-days: 90

      - name: Create Issue for Critical Findings
        if: steps.scan.outputs.critical_vulnerabilities > 0 || steps.scan.outputs.total_secrets > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'output/report.json';

            if (!fs.existsSync(reportPath)) {
              console.log('No report found');
              return;
            }

            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            const criticalVulns = report.vulnerabilities?.filter(v => v.severity === 'critical') || [];
            const highVulns = report.vulnerabilities?.filter(v => v.severity === 'high') || [];
            const secrets = report.secrets || [];

            if (criticalVulns.length === 0 && secrets.length === 0) {
              console.log('No critical findings');
              return;
            }

            let body = '## ðŸš¨ Security Scan Alert\n\n';
            body += `**Scan Date:** ${report.scan_date}\n`;
            body += `**Branch:** ${context.ref}\n`;
            body += `**Commit:** ${context.sha.substring(0, 7)}\n\n`;

            body += '### Summary\n\n';
            body += `- ðŸ”‘ **Secrets Found:** ${secrets.length}\n`;
            body += `- ðŸ› **Critical Vulnerabilities:** ${criticalVulns.length}\n`;
            body += `- âš ï¸ **High Vulnerabilities:** ${highVulns.length}\n\n`;

            if (secrets.length > 0) {
              body += '### ðŸ”‘ Hardcoded Secrets\n\n';
              secrets.slice(0, 5).forEach((secret, i) => {
                body += `${i + 1}. **${secret.type}** in \`${secret.file_path}:${secret.line_number}\`\n`;
                body += `   \`\`\`\n   ${secret.matched_text.substring(0, 100)}\n   \`\`\`\n`;
              });
              if (secrets.length > 5) {
                body += `\n... and ${secrets.length - 5} more secrets\n`;
              }
              body += '\n';
            }

            if (criticalVulns.length > 0) {
              body += '### ðŸ› Critical Vulnerabilities\n\n';
              criticalVulns.slice(0, 5).forEach((vuln, i) => {
                body += `${i + 1}. **${vuln.name}** (${vuln.cwe})\n`;
                body += `   - File: \`${vuln.file_path}:${vuln.line_number}\`\n`;
                body += `   - Category: ${vuln.category}\n`;
                body += `   - Recommendation: ${vuln.recommendation}\n\n`;
              });
              if (criticalVulns.length > 5) {
                body += `\n... and ${criticalVulns.length - 5} more critical vulnerabilities\n`;
              }
            }

            body += '\n---\n';
            body += 'ðŸ“Š **Full Report:** Check the workflow artifacts for detailed HTML/JSON reports\n';
            body += 'ðŸ”§ **Action Required:** Review and remediate these findings immediately\n';

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security-scan',
              per_page: 100
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Security Scan Alert') &&
              issue.created_at > new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## New Scan Results\n\n${body}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Security Scan Alert - ${new Date().toISOString().split('T')[0]}`,
                body: body,
                labels: ['security-scan', 'critical']
              });
              console.log('Created new security issue');
            }

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('output/report.json')) {
              return;
            }

            const report = JSON.parse(fs.readFileSync('output/report.json', 'utf8'));

            const totalSecrets = report.summary?.total_secrets || 0;
            const totalVulns = report.summary?.total_vulnerabilities || 0;
            const criticalVulns = report.summary?.vulnerability_stats?.by_severity?.critical || 0;
            const highVulns = report.summary?.vulnerability_stats?.by_severity?.high || 0;

            let status = 'âœ…';
            let message = 'No security issues found';

            if (criticalVulns > 0 || totalSecrets > 0) {
              status = 'ðŸš¨';
              message = 'Critical security issues found!';
            } else if (highVulns > 0) {
              status = 'âš ï¸';
              message = 'High severity issues found';
            } else if (totalVulns > 0) {
              status = 'âš ï¸';
              message = 'Security issues found';
            }

            const body = `## ${status} Security Scan Results\n\n` +
              `**Status:** ${message}\n\n` +
              `### Summary\n` +
              `- ðŸ”‘ Secrets: ${totalSecrets}\n` +
              `- ðŸ› Vulnerabilities: ${totalVulns}\n` +
              `  - Critical: ${criticalVulns}\n` +
              `  - High: ${highVulns}\n\n` +
              `ðŸ“Š View detailed reports in the workflow artifacts`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail on Critical Findings
        if: steps.scan.outputs.critical_vulnerabilities > 0 || steps.scan.outputs.total_secrets > 0
        run: |
          echo "::error::Critical security issues found!"
          echo "Secrets: ${{ steps.scan.outputs.total_secrets }}"
          echo "Critical Vulnerabilities: ${{ steps.scan.outputs.critical_vulnerabilities }}"
          exit 1
