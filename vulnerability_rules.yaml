# Advanced Vulnerability Detection Rules
# =====================================
# This file contains comprehensive security vulnerability detection patterns
# organized by OWASP Top 10 and CWE categories

vulnerabilities:
  # ============================================================
  # A03:2021 - Injection Vulnerabilities
  # ============================================================

  sql_injection:
    - name: "SQL Injection - String Concatenation"
      severity: critical
      cwe: CWE-89
      owasp: A03:2021
      pattern: '(execute|query|exec|SELECT|INSERT|UPDATE|DELETE|FROM|WHERE)\s*\(\s*["\'].*\+.*["\']'
      description: "SQL query built using string concatenation - vulnerable to SQL injection"
      recommendation: "Use parameterized queries or prepared statements"
      languages: [python, java, php, javascript, csharp]

    - name: "SQL Injection - Python String Format"
      severity: critical
      cwe: CWE-89
      owasp: A03:2021
      pattern: '(cursor\.execute|execute|query)\s*\(\s*["\'].*%s.*["\'].*%'
      description: "SQL query using Python string formatting - vulnerable to SQL injection"
      recommendation: "Use parameterized queries with ? or named placeholders"
      languages: [python]

    - name: "SQL Injection - JavaScript Template Literals"
      severity: critical
      cwe: CWE-89
      owasp: A03:2021
      pattern: '(query|execute|sql|db\.query)\s*\(\s*`.*\$\{.*\}`'
      description: "SQL query using template literals with user input"
      recommendation: "Use parameterized queries with placeholders"
      languages: [javascript, typescript]

    - name: "SQL Injection - PHP mysql_query"
      severity: critical
      cwe: CWE-89
      owasp: A03:2021
      pattern: '(mysql_query|mysqli_query|pg_query)\s*\(\s*["\'].*\$_?(GET|POST|REQUEST|COOKIE)'
      description: "Direct use of user input in SQL query"
      recommendation: "Use PDO or mysqli prepared statements"
      languages: [php]

  command_injection:
    - name: "Command Injection - Shell Execution"
      severity: critical
      cwe: CWE-78
      owasp: A03:2021
      pattern: '(exec|system|shell_exec|passthru|popen|proc_open|eval)\s*\(\s*.*\$_?(GET|POST|REQUEST)'
      description: "User input passed to shell execution function"
      recommendation: "Avoid shell execution or use escapeshellarg()/escapeshellcmd()"
      languages: [php, python, ruby]

    - name: "Command Injection - Python os.system"
      severity: critical
      cwe: CWE-78
      owasp: A03:2021
      pattern: 'os\.(system|popen|exec|spawn)\s*\(\s*.*\+.*\)'
      description: "Command built with string concatenation"
      recommendation: "Use subprocess with shell=False and argument list"
      languages: [python]

    - name: "Command Injection - Node.js child_process"
      severity: critical
      cwe: CWE-78
      owasp: A03:2021
      pattern: '(exec|spawn|execSync|spawnSync)\s*\(\s*`.*\$\{.*\}`'
      description: "Command injection via template literals"
      recommendation: "Use spawn() with argument array instead of exec()"
      languages: [javascript, typescript]

  ldap_injection:
    - name: "LDAP Injection"
      severity: high
      cwe: CWE-90
      owasp: A03:2021
      pattern: '(ldap_search|ldap_list|searchDN)\s*\(.*[+&].*\$_?(GET|POST|REQUEST)'
      description: "User input in LDAP query without sanitization"
      recommendation: "Escape special LDAP characters in user input"
      languages: [php, python, java]

  xpath_injection:
    - name: "XPath Injection"
      severity: high
      cwe: CWE-643
      owasp: A03:2021
      pattern: '(xpath|evaluate|selectNodes)\s*\(.*[+&].*\$_?(GET|POST|REQUEST)'
      description: "User input in XPath query"
      recommendation: "Use parameterized XPath queries"
      languages: [php, python, java, javascript]

  # ============================================================
  # A03:2021 - Cross-Site Scripting (XSS)
  # ============================================================

  xss:
    - name: "XSS - Direct Echo/Print"
      severity: high
      cwe: CWE-79
      owasp: A03:2021
      pattern: '(echo|print|printf)\s+\$_?(GET|POST|REQUEST|COOKIE)'
      description: "User input directly printed to output without sanitization"
      recommendation: "Use htmlspecialchars() or htmlentities()"
      languages: [php]

    - name: "XSS - innerHTML Assignment"
      severity: high
      cwe: CWE-79
      owasp: A03:2021
      pattern: '\.innerHTML\s*=\s*.*(?!textContent)'
      description: "innerHTML used which can execute scripts"
      recommendation: "Use textContent or sanitize input with DOMPurify"
      languages: [javascript, typescript]

    - name: "XSS - React dangerouslySetInnerHTML"
      severity: high
      cwe: CWE-79
      owasp: A03:2021
      pattern: 'dangerouslySetInnerHTML\s*=\s*\{\{.*\}\}'
      description: "Potentially unsafe HTML rendering in React"
      recommendation: "Sanitize HTML with DOMPurify before rendering"
      languages: [javascript, typescript, jsx, tsx]

    - name: "XSS - Document.write"
      severity: high
      cwe: CWE-79
      owasp: A03:2021
      pattern: 'document\.write\s*\(\s*.*(?:location|window\.location|params|query)'
      description: "document.write() with user-controlled input"
      recommendation: "Avoid document.write() or sanitize input"
      languages: [javascript, typescript]

    - name: "XSS - Python Template without Escape"
      severity: high
      cwe: CWE-79
      owasp: A03:2021
      pattern: '\{\{\s*request\.(GET|POST|args|form).*\|safe\s*\}\}'
      description: "Jinja2 template rendering user input as safe HTML"
      recommendation: "Remove |safe filter or sanitize input"
      languages: [python]

  # ============================================================
  # A05:2021 - Security Misconfiguration
  # ============================================================

  debug_mode:
    - name: "Debug Mode Enabled in Production"
      severity: medium
      cwe: CWE-489
      owasp: A05:2021
      pattern: '(DEBUG\s*=\s*True|debug\s*:\s*true|\.DEBUG\s*=\s*1|app\.debug\s*=\s*True)'
      description: "Debug mode enabled - may expose sensitive information"
      recommendation: "Disable debug mode in production"
      languages: [python, javascript, php, ruby]

    - name: "Error Display Enabled"
      severity: medium
      cwe: CWE-209
      owasp: A05:2021
      pattern: '(display_errors\s*=\s*On|error_reporting\s*\(\s*E_ALL|SHOW_ERRORS\s*=\s*true)'
      description: "Detailed error messages enabled - may leak information"
      recommendation: "Disable error display in production"
      languages: [php]

  insecure_cors:
    - name: "Insecure CORS - Wildcard Origin"
      severity: high
      cwe: CWE-942
      owasp: A05:2021
      pattern: 'Access-Control-Allow-Origin\s*:\s*\*'
      description: "CORS allows all origins - potential security risk"
      recommendation: "Restrict to specific trusted origins"
      languages: [all]

  # ============================================================
  # A02:2021 - Cryptographic Failures
  # ============================================================

  weak_crypto:
    - name: "Weak Hashing Algorithm - MD5"
      severity: high
      cwe: CWE-328
      owasp: A02:2021
      pattern: '(md5|MD5|hashlib\.md5)\s*\('
      description: "MD5 is cryptographically broken - should not be used"
      recommendation: "Use SHA-256, SHA-3, or bcrypt for passwords"
      languages: [all]

    - name: "Weak Hashing Algorithm - SHA1"
      severity: high
      cwe: CWE-328
      owasp: A02:2021
      pattern: '(sha1|SHA1|hashlib\.sha1)\s*\('
      description: "SHA1 is deprecated and vulnerable to collisions"
      recommendation: "Use SHA-256 or SHA-3"
      languages: [all]

    - name: "Insecure Random Number Generation"
      severity: medium
      cwe: CWE-338
      owasp: A02:2021
      pattern: '(Math\.random\(\)|random\.random\(\)|rand\(\)|mt_rand\(\))'
      description: "Insecure random number generator used"
      recommendation: "Use crypto.getRandomValues() or secrets module"
      languages: [javascript, python, php]

    - name: "Weak SSL/TLS Configuration"
      severity: high
      cwe: CWE-326
      owasp: A02:2021
      pattern: '(SSLv2|SSLv3|TLSv1\.0|TLSv1\.1|PROTOCOL_SSLv|PROTOCOL_TLSv1)'
      description: "Outdated SSL/TLS protocol version"
      recommendation: "Use TLS 1.2 or TLS 1.3"
      languages: [all]

    - name: "Hardcoded Encryption Key"
      severity: critical
      cwe: CWE-321
      owasp: A02:2021
      pattern: '(AES|DES|encrypt|cipher).*key\s*=\s*["\'][^"\']{16,}["\']'
      description: "Encryption key hardcoded in source code"
      recommendation: "Store keys in secure key management system"
      languages: [all]

  # ============================================================
  # A01:2021 - Broken Access Control
  # ============================================================

  path_traversal:
    - name: "Path Traversal - Directory Traversal"
      severity: critical
      cwe: CWE-22
      owasp: A01:2021
      pattern: '(open|readFile|include|require|file_get_contents)\s*\(.*\$_?(GET|POST|REQUEST)'
      description: "File path from user input - vulnerable to path traversal"
      recommendation: "Validate and sanitize file paths, use whitelisting"
      languages: [php, python, javascript, ruby]

    - name: "Path Traversal - Python open()"
      severity: critical
      cwe: CWE-22
      owasp: A01:2021
      pattern: 'open\s*\(\s*.*request\.(GET|POST|args|form)'
      description: "File opened with user-controlled path"
      recommendation: "Validate path and use os.path.basename()"
      languages: [python]

  insecure_direct_object_reference:
    - name: "Insecure Direct Object Reference"
      severity: high
      cwe: CWE-639
      owasp: A01:2021
      pattern: 'SELECT.*FROM.*WHERE\s+id\s*=\s*\$_?(GET|POST)\[.id.\]'
      description: "Database query using user-supplied ID without authorization"
      recommendation: "Implement proper authorization checks"
      languages: [php, python]

  # ============================================================
  # A08:2021 - Software and Data Integrity Failures
  # ============================================================

  insecure_deserialization:
    - name: "Insecure Deserialization - Python pickle"
      severity: critical
      cwe: CWE-502
      owasp: A08:2021
      pattern: 'pickle\.(loads?|Unpickler)\s*\('
      description: "pickle.loads() can execute arbitrary code"
      recommendation: "Use JSON or implement object whitelist validation"
      languages: [python]

    - name: "Insecure Deserialization - PHP unserialize"
      severity: critical
      cwe: CWE-502
      owasp: A08:2021
      pattern: 'unserialize\s*\(\s*\$_?(GET|POST|REQUEST|COOKIE)'
      description: "unserialize() with user input can execute code"
      recommendation: "Use JSON or validate serialized data"
      languages: [php]

    - name: "Insecure Deserialization - Java ObjectInputStream"
      severity: critical
      cwe: CWE-502
      owasp: A08:2021
      pattern: 'ObjectInputStream.*readObject'
      description: "Java deserialization can lead to RCE"
      recommendation: "Implement look-ahead deserialization or use JSON"
      languages: [java]

  # ============================================================
  # A09:2021 - Security Logging and Monitoring Failures
  # ============================================================

  insufficient_logging:
    - name: "Authentication Without Logging"
      severity: medium
      cwe: CWE-778
      owasp: A09:2021
      pattern: '(login|authenticate|verify_password).*(?!log|logger|audit)'
      description: "Authentication attempt not logged"
      recommendation: "Log all authentication attempts"
      languages: [all]

  # ============================================================
  # A10:2021 - Server-Side Request Forgery (SSRF)
  # ============================================================

  ssrf:
    - name: "SSRF - URL from User Input"
      severity: high
      cwe: CWE-918
      owasp: A10:2021
      pattern: '(requests\.get|fetch|axios\.get|curl_exec|file_get_contents)\s*\(.*\$_?(GET|POST|REQUEST)'
      description: "HTTP request to user-controlled URL - SSRF risk"
      recommendation: "Validate and whitelist URLs, block internal IPs"
      languages: [python, javascript, php]

  # ============================================================
  # XML External Entity (XXE)
  # ============================================================

  xxe:
    - name: "XXE - XML Parser Without Hardening"
      severity: high
      cwe: CWE-611
      owasp: A05:2021
      pattern: '(XMLParser|parseXML|DOMDocument|simplexml_load|xml\.etree)(?!.*disable.*entity)'
      description: "XML parser without entity expansion disabled"
      recommendation: "Disable external entity processing"
      languages: [php, python, java]

  # ============================================================
  # Dangerous Functions
  # ============================================================

  dangerous_functions:
    - name: "Dangerous Function - eval()"
      severity: critical
      cwe: CWE-95
      owasp: A03:2021
      pattern: '\beval\s*\('
      description: "eval() executes arbitrary code - extremely dangerous"
      recommendation: "Avoid eval() entirely or use safe alternatives"
      languages: [python, javascript, php]

    - name: "Dangerous Function - exec()"
      severity: critical
      cwe: CWE-78
      owasp: A03:2021
      pattern: '\bexec\s*\('
      description: "exec() can execute system commands"
      recommendation: "Use safer alternatives or strict input validation"
      languages: [python, php]

    - name: "Dangerous Function - assert()"
      severity: high
      cwe: CWE-95
      owasp: A03:2021
      pattern: '\bassert\s*\('
      description: "assert() can execute arbitrary code in PHP"
      recommendation: "Use proper validation instead of assertions"
      languages: [php]

    - name: "File Inclusion - include/require"
      severity: high
      cwe: CWE-98
      owasp: A03:2021
      pattern: '(include|require|include_once|require_once)\s*\(.*\$_?(GET|POST|REQUEST)'
      description: "Dynamic file inclusion with user input"
      recommendation: "Use whitelist of allowed files"
      languages: [php]

  # ============================================================
  # Information Disclosure
  # ============================================================

  information_disclosure:
    - name: "Sensitive Information in Comments"
      severity: low
      cwe: CWE-615
      owasp: A05:2021
      pattern: '(//|#|/\*).*(?:password|secret|key|token|api[_-]?key).*[:=]'
      description: "Potentially sensitive information in comments"
      recommendation: "Remove sensitive data from comments"
      languages: [all]

    - name: "Stack Trace in Response"
      severity: medium
      cwe: CWE-209
      owasp: A05:2021
      pattern: '(print_r|var_dump|console\.error)\s*\(.*exception|error'
      description: "Stack traces or error details exposed to users"
      recommendation: "Log errors server-side, show generic messages to users"
      languages: [php, javascript, python]

  # ============================================================
  # Hardcoded Credentials & Secrets
  # ============================================================

  hardcoded_secrets:
    - name: "Hardcoded Database Password"
      severity: critical
      cwe: CWE-798
      owasp: A07:2021
      pattern: '(password|passwd|pwd)\s*=\s*["\'][^"\'\s]{4,}["\']'
      description: "Database password hardcoded in source"
      recommendation: "Use environment variables or secrets management"
      languages: [all]

    - name: "Hardcoded IP Address"
      severity: low
      cwe: CWE-547
      owasp: A05:2021
      pattern: '\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b'
      description: "IP address hardcoded in source"
      recommendation: "Use configuration files or environment variables"
      languages: [all]

  # ============================================================
  # Regular Expression Denial of Service (ReDoS)
  # ============================================================

  redos:
    - name: "Potential ReDoS - Catastrophic Backtracking"
      severity: medium
      cwe: CWE-1333
      owasp: A05:2021
      pattern: '(re\.compile|RegExp|preg_match)\s*\([^)]*(\(.*\+.*\)\+|\(.*\*.*\)\*)'
      description: "Regular expression with potential catastrophic backtracking"
      recommendation: "Simplify regex or add timeout limits"
      languages: [python, javascript, php]

  # ============================================================
  # Race Conditions
  # ============================================================

  race_condition:
    - name: "Time-of-check Time-of-use (TOCTOU)"
      severity: medium
      cwe: CWE-367
      owasp: A04:2021
      pattern: 'if\s+os\.path\.exists.*\n.*open'
      description: "File existence check followed by open - race condition"
      recommendation: "Use try/except with open() instead of checking first"
      languages: [python]

  # ============================================================
  # Missing Security Headers
  # ============================================================

  missing_security_headers:
    - name: "Missing Content-Security-Policy"
      severity: medium
      cwe: CWE-693
      owasp: A05:2021
      pattern: 'res\.setHeader\((?!.*Content-Security-Policy)'
      description: "Missing Content-Security-Policy header"
      recommendation: "Add CSP header to prevent XSS"
      languages: [javascript, typescript]

  # ============================================================
  # Denial of Service
  # ============================================================

  dos:
    - name: "Uncontrolled Resource Consumption"
      severity: medium
      cwe: CWE-400
      owasp: A05:2021
      pattern: 'while\s*\(\s*true\s*\)|for\s*\(\s*;\s*;\s*\)'
      description: "Infinite loop - potential DoS"
      recommendation: "Add break conditions or timeout"
      languages: [all]
